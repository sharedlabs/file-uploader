<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../input-file/input-file.html">

<!--
`file-uploader`

@demo demo/index.html
-->

<dom-module id="file-uploader">
  <template>

    <style>
      :host {
        display: none;
      }
    </style>

  </template>
</dom-module>

<script>
(function() {
  'use strict';

  Polymer({

    is: 'file-uploader',

    properties: {

      url: {
        type: String,
      },

      progress: {
        type: Number
      },

      /**
       * @type {Object[]} detail
       * @property {File} detail[].file
       * @property {number} detail[].progress
       */
      files: {
        type: Array,
        value: _ => [],
        notify: true,
        readOnly: true,
      },

      filesProgress: {
        type: WeakMap,
        value: _ => new WeakMap(),
        notify: true,
        readOnly: true,
      },

    },

    listener: {
      'files-selected': '_onFilesSelected',
    },

    selectFiles() {
      const event = new CustomEvent('click');
      this.$.inputFile.dispatchEvent(event);
    },

    uploadFile(file, url) {
      this.filesProgress.set(file, 0);

      // if () {

      // }

      this._updateProgress();
    },

    _onFilesSelected(event) {
      const files = event.detail.files;
      event.preventDefault();

      if (this.progress === 100) {
        this._clearUpload();
      }

      for (let file of files) {
        if (!this._fileIsWaiting(file)) {
          this.files.push(file);
        }
      }
      this._updatePendingFiles();
    },

    _updateProgress() {
      const completedFiles = this.files.find(file => {
        return this.filesProgress.get(file) === 100;
      }) ||Â [];
      const progress = completedFiles.length / this.files.length;
      this.progress = Math.round(progress);
    },

    _updatePendingFiles() {
      for (let file of this.files) {
        if (this.filesProgress.get(file) === undefined) {
          this.uploadFile(file, this.url);
        }
      }
    },

    _clearUpload() {
      this.files.splice(0);
      this.progress = null;
    },

    _fileIsWaiting(file) {
      return this.files.find(f => {
        return f.name === file.name && f.size === file.size;
      });
    }

  });

}());
</script>
