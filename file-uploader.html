<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../input-file/input-file.html">

<!--
`file-uploader`

@demo demo/index.html
-->

<dom-module id="file-uploader">
  <template>

    <style>
      :host {
        display: none;
      }
    </style>

  </template>
</dom-module>

<script>
(function() {
  'use strict';

  Polymer({

    is: 'file-uploader',

    properties: {

      url: {
        type: String,
      },

      progress: {
        type: Number
      },

      files: {
        type: Array,
        value: _ => [],
        notify: true,
        readOnly: true,
      },

      filesProgress: {
        type: WeakMap,
        value: _ => new WeakMap(),
        notify: true,
        readOnly: true,
      },

      beforeUpload: {
        type: Function,
      }

    },

    uploadFile(files) {
      if (files.constructor.name === 'File') {
        files = [files];
      }

      if (this.progress === 100) {
        this._clearUpload();
      }

      for (let file of files) {
        if (!this._isFileAdded(file)) {
          this.files.push(file);
          this.filesProgress.set(file, 0);

          Promise.resolve().then(_ => {
            if (typeof this.beforeUpload === 'function') {
              return this.beforeUpload(file);
            }
          }).then(url => {
            this._xhr({
              url: url || this.url,
              file
            });
          });
        }
      }

      this._updateProgress();
    },

    _updateProgress() {
      const completedFiles = this.files.find(file => {
        return this.filesProgress.get(file) === 100;
      }) ||Â [];
      const progress = completedFiles.length / this.files.length;
      this.progress = Math.round(progress);
    },

    _clearUpload() {
      this.files.splice(0);
      this.progress = null;
    },

    _isFileAdded(file) {
      return this.files.find(f => {
        return f.name === file.name && f.size === file.size;
      });
    },

    _xhr({url, contentType, file}) {
      return new Promise((resolve, reject) => {
        if (!url) {
          return reject(new Error('no url'));
        }

        const xhr = new XMLHttpRequest();
        xhr.addEventListener('load', event => {
          resolve(event.currentTarget.response);
        });
        xhr.addEventListener('error', event => {
          reject(event.currentTarget.response);
        });
        xhr.open('POST', url);
        if (contentType) {
          xhr.setRequestHeader('Content-type', contentType);
        }
        xhr.send(file);
      });
    },

  });

}());
</script>
