<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-image/iron-image.html">
<link rel="import" href="../overlay-container/animated-overlay-behavior.html">
<link rel="import" href="../paper-progress/paper-progress.html">

<!--
`file-uploader`

@demo demo/index.html
-->
<dom-module id="file-uploader-progress">
  <template strip-whitespace>
    <style>
      :host {
        background: white;
        border-radius: 4px;
        box-shadow: 0 16px 24px 2px rgba(0,0,0,0.14), 0 6px 30px 5px rgba(0,0,0,0.12), 0 8px 10px -5px rgba(0,0,0,0.2);
        display: inline-block;
        height: 100px;
        width: 320px;
      }

      .content {
        @apply(--layout-horizontal);
        height: 100%;
      }

      iron-image {
        width: 100px;
        height: 100%;
      }

      button {
        background: none;
        border-radius: 3px;
        border: none;
        bottom: 12px;
        color: var(--file-uploader-progress-color, #2196f3);
        cursor: pointer;
        font-weight: 600;
        outline: 0;
        padding: 6px 10px;
        position: absolute;
        right: 20px;
        font-size: 14px;
        text-transform: uppercase;
        @apply(--file-uploader-progress-button);
      }

      button:hover {
        background: #f2f2f2;
      }

      .details {
        @apply(--layout-vertical);
        @apply(--layout-flex);
        box-sizing: border-box;
        padding: 12px 25px 16px;
        position: relative;
      }

      .uploading-to-text {
        @apply(--layout-flex);
        margin: 2px 0;
      }

      .caption {
        color: #666;
        font-size: 13px;
      }

      #paperProgress {
        bottom: 0;
        height: 4px;
        left: 0;
        position: absolute;
        width: 100%;
        --paper-progress-active-color: var(--file-uploader-progress-color, #2196f3);
      }
    </style>

    <div class="content">
      <iron-image sizing="cover" src$="[[_currentFileDataURL]]"></iron-image>

      <div class="details">
        <div class="caption">Uploading...</div>
        <div class="uploading-to-text">[[uploadingToText]]</div>
        <div class="caption">[[_computeCurrentUploadIndex(_currentFile)]] of [[files.length]]</div>
        <button on-tap="_stopTapped">Stop<paper-ripple></paper-ripple></button>
        <paper-progress id="paperProgress" indeterminate></paper-progress>
      </div>
    </div>

  </template>
</dom-module>

<script>
(function() {
  'use strict';

  Polymer({

    is: 'file-uploader-progress',

    properties: {

      // General upload progress
      progress: {
        type: Number,
        notify: true,
        observer: '_progressChanged',
      },

      // Array of files
      files: {
        type: Array
      },

      // Weakmap of files progress weakmap
      filesProgress: {
        type: Object,
      },

      uploadingToText: {
        type: String,
      },

      // @override the OverlayBehavior property
      noCancelOnEscKey: {
        type: Boolean,
        value: true
      },

      // @override the OverlayBehavior property
      noCancelOnPopState: {
        type: Boolean,
        value: true
      },

      /**
       * The file that is being currently uploaded.
       *
       * @type {!File}
       */
      _currentFile: {
        type: Object,
        observer: '_currentFileChanged'
      },

      _currentFileDataURL: {
        type: String,
      }

    },

    behaviors: [
      AnimatedOverlayBehavior
    ],

    observers: [
      '_filesChanged(files.*)'
    ],

    refresh() {
      if (this.progress === 100 || typeof this.progress !== 'number') {
        this.opened = false;
      } else {
        this._currentFile = this._getFileInProgress();
      }
      this._opened = this.opened;
    },

    _progressChanged() {
      this.refresh();
    },

    _filesChanged() {
      this.opened = this.files && this.files.length;
    },

    _currentFileChanged(currentFile) {
      if (currentFile) {
        const isImage = /image\/.*/.exec(currentFile.type);

        if (isImage) {
          this._currentFileDataURL = URL.createObjectURL(currentFile);
        }
      }
    },

    _stopTapped() {
      this.fire('upload-stop');
    },

    /**
     * Return the file that is currently being uploaded.
     */
    _getFileInProgress() {
      return (this.files || []).filter(file => {
        const progress = this.filesProgress.get(file);
        const isUploading = typeof progress === 'number' && progress < 100;
        return isUploading;
      })[0];
    },

    /**
     * Return already uploaded files.
     */
    _getUploadedFiles() {
      return (this.files || []).filter(file => {
        return this.filesProgress.get(file) === 100;
      });
    },

    _computeCurrentUploadIndex(currentFile) {
      return this._getUploadedFiles().length + 1;
    }

  });

}());
</script>
