<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../overlay-container/animated-overlay-behavior.html">
<link rel="import" href="../app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="../iron-image/iron-image.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">

<!--
`file-uploader-completed-overlay`

@demo demo/index.html
-->
<dom-module id="file-uploader-completed-overlay">
  <template>
    <style>
      :host {
        background: white;
        border-radius: 4px;
        bottom: 20px;
        box-shadow: 0 16px 24px 2px rgba(0,0,0,0.14), 0 6px 30px 5px rgba(0,0,0,0.12), 0 8px 10px -5px rgba(0,0,0,0.2);
        display: inline-block;
        left: 20px;
        min-height: 100px;
        overflow: hidden;
        position: fixed;
        right: 20px;
      }

      @media(min-width: 642px) {
        :host {
          bottom: 30px;
          left: 30px;
          right: auto;
          width: 320px;
        }
      }

      .header {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        padding: 8px 20px;
      }

      .header__title {
        @apply(--layout-flex);
        font-size: 18px;
      }

      .header__close {
        cursor: pointer;
        fill: var(--paper-grey-500);
        height: 22px;
        margin-right: -8px;
        padding: 8px;
        width: 22px;
      }

      .files {
        @apply(--layout-horizontal);
        @apply(--layout-wrap);
      }

      .file__iron-image {
        height: 100%;
        width: 100%;
      }
    </style>

    <div id="container">
      <div class="header">
        <div class="header__title">[[_computeHeaderTitle(files, localize)]]</div>
        <svg class="header__close" on-tap="_closeTapped" viewBox="0 0 24 24">
          <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" />
        </svg>
      </div>

      <div class="files">
        <template is="dom-repeat" items="[[_filteredFiles]]">
          <div class="file" style$="[[_computeFileStyle(_filteredFiles.length, index)]]">
            <iron-image
                class="file__iron-image"
                src="[[_computeThumbnail(item)]]"
                sizing="cover"></iron-image>
          </div>
        </template>
      </div>
    </div>

  </template>
</dom-module>

<script>
(function() {
  'use strict';

  Polymer({

    is: 'file-uploader-completed-overlay',

    properties: {

      files: {
        type: Array,
        value: _ => [],
        observer: '_filesChanged'
      },

      language: {
        type: String,
        value: 'en'
      },

      resources: {
        value: _ => {
          return {
            'en': {
              'HeaderTitle': '{length} items uploaded'
            },
            'es': {
              'HeaderTitle': 'Se han subido {length} elementos'
            }
          };
        }
      },

      // @override AnimatedOverlayBehavior
      noCancelOnEscKey: {
        type: Boolean,
        value: true
      },

      // @override AnimatedOverlayBehavior
      noCancelOnPopState: {
        type: Boolean,
        value: true
      },

      // @override AnimatedOverlayBehavior
      removeOnClose: {
        type: Boolean,
        value: false
      },

      _filteredFiles: Array

    },

    behaviors: [
      AnimatedOverlayBehavior,
      Polymer.AppLocalizeBehavior
    ],

    _filesChanged(files) {
      if (Array.isArray(files)) {
        this._filteredFiles = files.slice(0).reverse().splice(0, 6);
      }
    },

    _computeHeaderTitle(files) {
      return this.localize('HeaderTitle', 'length', files.length);
    },

    _computeFileStyle(filesLength, fileIndex) {
      let styleAttr = '';

      if (filesLength === 1) {
        styleAttr = 'height: 200px; width: 100%;'
      } else {
        styleAttr = 'width: calc(50% - 1px); height: 100px; margin-top: 2px;';

        if (!(fileIndex % 2)) {
          styleAttr += ' margin-right: 2px;';
        }
      }

      return styleAttr;
    },

    _computeThumbnail(file) {
      const isImage = /image\/.*/.exec(file.type);

      if (isImage) {
        return URL.createObjectURL(file);
      }
    },

    _closeTapped() {
      this.removeOnClose = true;
      this.opened = false;
    }

  });

}());
</script>
